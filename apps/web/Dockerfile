FROM node:18-alpine
RUN apk add --no-cache libc6-compat git python3 py3-pip make g++ libusb-dev eudev-dev linux-headers

# Set working directory
WORKDIR /app

# Copy root
COPY . .

# Set working directory to the web app
WORKDIR apps/web

# Enable corepack and configure yarn
RUN corepack enable
RUN yarn config set httpTimeout 300000

# Run any custom post-install scripts
RUN yarn install --immutable
RUN yarn after-install

# ============================================
# Receive build arguments from Render
# Render passes these variables via --build-arg
# ============================================
ARG NEXT_PUBLIC_BRAND_NAME
ARG NEXT_PUBLIC_IS_OFFICIAL_HOST
ARG NEXT_PUBLIC_DEFAULT_MAINNET_CHAIN_ID
ARG NEXT_PUBLIC_GATEWAY_URL_PRODUCTION
ARG NEXT_PUBLIC_GATEWAY_URL_STAGING
ARG NEXT_PUBLIC_WC_PROJECT_ID
ARG NEXT_PUBLIC_IS_PRODUCTION
ARG NEXT_PUBLIC_PROD_MIXPANEL_TOKEN
ARG NEXT_PUBLIC_STAGING_MIXPANEL_TOKEN
ARG NEXT_PUBLIC_INFURA_TOKEN
ARG NEXT_PUBLIC_SAFE_APPS_INFURA_TOKEN
ARG NEXT_PUBLIC_BEAMER_ID
ARG NEXT_PUBLIC_SENTRY_DSN
ARG NEXT_PUBLIC_DATADOG_CLIENT_TOKEN
ARG DISABLE_ESLINT_PLUGIN
ARG NODE_OPTIONS

# ============================================
# Convert ARG to ENV (required for Next.js build)
# ============================================
ENV NEXT_PUBLIC_BRAND_NAME=$NEXT_PUBLIC_BRAND_NAME
ENV NEXT_PUBLIC_IS_OFFICIAL_HOST=$NEXT_PUBLIC_IS_OFFICIAL_HOST
ENV NEXT_PUBLIC_DEFAULT_MAINNET_CHAIN_ID=$NEXT_PUBLIC_DEFAULT_MAINNET_CHAIN_ID
ENV NEXT_PUBLIC_GATEWAY_URL_PRODUCTION=$NEXT_PUBLIC_GATEWAY_URL_PRODUCTION
ENV NEXT_PUBLIC_GATEWAY_URL_STAGING=$NEXT_PUBLIC_GATEWAY_URL_STAGING
ENV NEXT_PUBLIC_WC_PROJECT_ID=$NEXT_PUBLIC_WC_PROJECT_ID
ENV NEXT_PUBLIC_IS_PRODUCTION=$NEXT_PUBLIC_IS_PRODUCTION
ENV NEXT_PUBLIC_PROD_MIXPANEL_TOKEN=$NEXT_PUBLIC_PROD_MIXPANEL_TOKEN
ENV NEXT_PUBLIC_STAGING_MIXPANEL_TOKEN=$NEXT_PUBLIC_STAGING_MIXPANEL_TOKEN
ENV NEXT_PUBLIC_INFURA_TOKEN=$NEXT_PUBLIC_INFURA_TOKEN
ENV NEXT_PUBLIC_SAFE_APPS_INFURA_TOKEN=$NEXT_PUBLIC_SAFE_APPS_INFURA_TOKEN
ENV NEXT_PUBLIC_BEAMER_ID=$NEXT_PUBLIC_BEAMER_ID
ENV NEXT_PUBLIC_SENTRY_DSN=$NEXT_PUBLIC_SENTRY_DSN
ENV NEXT_PUBLIC_DATADOG_CLIENT_TOKEN=$NEXT_PUBLIC_DATADOG_CLIENT_TOKEN
ENV DISABLE_ESLINT_PLUGIN=$DISABLE_ESLINT_PLUGIN
ENV NODE_OPTIONS=$NODE_OPTIONS

# Fixed environment variables
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=10000

# Expose the port
EXPOSE 10000

# Command to start the application
CMD ["yarn", "static-serve"]
